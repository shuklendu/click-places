<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script>
      THREEx.ArToolkitContext.baseURL =
        'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/';
    </script>
    <!-- Dynamically add places from Javascript -->
    <script>
      const loadPlaces = function (coords) {
        // COMMENT FOLLOWING LINE IF YOU WANT TO USE STATIC DATA AND ADD COORDINATES IN THE FOLLOWING 'PLACES' ARRAY
        const method = 'apix';

        const PLACES = [
          {
            name: 'Manpada Petrol Pump Bus Station',
            location: {
              lat: 19.18635, // add here latitude if using static data
              lng: 73.09144, // add here longitude if using static data
            },
          },
        ];

        if (method === 'api') {
          return loadPlaceFromAPIs(coords);
        }

        return Promise.resolve(PLACES);
      };

      // getting places from REST APIs
      function loadPlaceFromAPIs(position) {
        const params = {
          radius: 300, // search places not farther than this value (in meters)
          clientId: 'HZIJGI4COHQ4AI45QXKCDFJWFJ1SFHYDFCCWKPIJDWHLVQVZ',
          clientSecret: '',
          version: '20300101', // foursquare versioning, required but unuseful for this demo
        };

        // CORS Proxy to avoid CORS problems
        const corsProxy = 'https://cors-anywhere.herokuapp.com/';

        // Foursquare API
        const endpoint = `${corsProxy}https://api.foursquare.com/v2/venues/search?intent=checkin
      &ll=${position.latitude},${position.longitude}
      &radius=${params.radius}
      &client_id=${params.clientId}
      &client_secret=${params.clientSecret}
      &limit=15
      &v=${params.version}`;
        return fetch(endpoint)
          .then((res) => {
            return res.json().then((resp) => {
              return resp.response.venues;
            });
          })
          .catch((err) => {
            console.error('Error with places API', err);
          });
      }
      function onLoad() {
        const scene = document.querySelector('a-scene');
        // first get current user location
        return navigator.geolocation.getCurrentPosition(
          function (position) {
            // then use it to load from remote APIs some places nearby
            loadPlaces(position.coords).then((places) => {
              places.forEach((place) => {
                const latitude = place.location.lat;
                const longitude = place.location.lng;

                // add place icon
                const icon = document.createElement('a-image');
                icon.setAttribute(
                  'gps-entity-place',
                  `latitude: ${latitude}; longitude: ${longitude}`
                );
                icon.setAttribute('name', place.name);
                icon.setAttribute('src', '../assets/map-marker.png');

                // for debug purposes, just show in a bigger scale, otherwise I have to personally go on places...
                icon.setAttribute('scale', '20, 20');

                icon.addEventListener('loaded', () =>
                  window.dispatchEvent(
                    new CustomEvent('gps-entity-place-loaded')
                  )
                );

                const clickListener = function (ev) {
                  ev.stopPropagation();
                  ev.preventDefault();

                  const name = ev.target.getAttribute('name');

                  const el =
                    ev.detail.intersection && ev.detail.intersection.object.el;

                  if (el && el === ev.target) {
                    const label = document.createElement('span');
                    const container = document.createElement('div');
                    container.setAttribute('id', 'place-label');
                    label.innerText = name;
                    container.appendChild(label);
                    document.body.appendChild(container);

                    setTimeout(() => {
                      container.parentElement.removeChild(container);
                    }, 1500);
                  }
                };

                icon.addEventListener('click', clickListener);

                scene.appendChild(icon);
              });
            });
          },
          (err) => console.error('Error in retrieving position', err),
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000,
          }
        );
      }
      setTimeout(onLoad, 4000);
      /*window.addEventListener
        ? window.addEventListener('load', onLoad, false)
        : window.attachEvent && window.attachEvent('onload', onLoad);*/
    </script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <my-app>loading</my-app>
  </body>
</html>
